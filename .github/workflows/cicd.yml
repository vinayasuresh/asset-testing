name: Deploy AssetNext (App + DB)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”‘ Log in to GitHub Container Registry
        run: |
          echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} --password-stdin
      - name: ðŸ—ï¸ Build and push app image
        run: |
          USERNAME=$(echo "${{ secrets.GHCR_USERNAME }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_NAME=ghcr.io/$USERNAME/assetnext:latest
          echo "ðŸ“¦ Building image: $IMAGE_NAME"
          docker build -t $IMAGE_NAME .
          docker push $IMAGE_NAME
      - name: ðŸš€ Deploy to remote server
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 20m
          script: |
            set -e
            USERNAME=$(echo "${{ secrets.GHCR_USERNAME }}" | tr '[:upper:]' '[:lower:]')
            APP_IMAGE=ghcr.io/$USERNAME/assetnext:latest
            DB_CONTAINER=assetnext_db
            APP_CONTAINER=assetnext_app
            NETWORK_NAME=asset_network

            echo "ðŸ§¹ Removing existing app container (if any)..."
            docker rm -f $APP_CONTAINER 2>/dev/null || true

            echo "ðŸŒ Creating Docker network..."
            docker network create $NETWORK_NAME || true

              echo "ðŸ§¹ Keeping only the last two assetnext images..."
              IMAGE_IDS=$(docker images --format '{{.ID}} {{.Repository}} {{.Tag}} {{.CreatedAt}}' | grep 'ghcr.io/.*/assetnext' | sort -rk4 | awk '{print $1}' | tail -n +3)
              for img_id in $IMAGE_IDS; do
                echo "ðŸ—‘ï¸ Removing old assetnext image: $img_id"
                docker rmi -f $img_id || true
              done

            echo "ðŸ“¦ Pulling latest app image..."
            docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} -p ${{ secrets.GHCR_TOKEN }}
            docker pull $APP_IMAGE

            echo "ðŸ—„ï¸ Creating volume for Postgres..."
            docker volume create asset_pgdata || true

            echo "ðŸ˜ Ensuring Postgres container is running..."
            if ! docker ps --format '{{.Names}}' | grep -q "^${DB_CONTAINER}$"; then
              echo "Starting new Postgres container..."
              docker rm $DB_CONTAINER 2>/dev/null || true
              docker run -d \
                --name $DB_CONTAINER \
                --network $NETWORK_NAME \
                -e POSTGRES_USER=asset \
                -e POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }} \
                -e POSTGRES_DB=assetnext \
                -p 5928:5432 \
                -v asset_pgdata:/var/lib/postgresql/data \
                --restart unless-stopped \
                postgres:15-alpine
              echo "â³ Waiting 15s for DB to initialize..."
              sleep 15
            else
              echo "Postgres container already running"
              # Ensure it's on the right network
              docker network connect $NETWORK_NAME $DB_CONTAINER 2>/dev/null || true
            fi

            echo "ðŸš€ Starting AssetNext app container..."
            docker run -d \
              --name $APP_CONTAINER \
              --network $NETWORK_NAME \
              -e NODE_ENV=production \
              -e PORT=5926 \
              -e HOST=0.0.0.0 \
              -e SESSION_SECRET=${{ secrets.APP_SESSION_SECRET }} \
              -e DATABASE_URL="postgresql://asset:${{ secrets.DB_PASSWORD }}@$DB_CONTAINER:5432/assetnext" \
              -e POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }} \
              -e OA_BASE_URL=${{ secrets.OA_BASE_URL }} \
              -e OA_USERNAME=${{ secrets.OA_USERNAME }} \
              -e OA_PASSWORD=${{ secrets.OA_PASSWORD }} \
              -e PUBLIC_URL=${{ secrets.PUBLIC_URL }} \
              -e PRODUCTION_URL=${{ secrets.PUBLIC_URL }} \
              -e AGENT_ENROLL_URL=${{ secrets.AGENT_ENROLL_URL }} \
              -p 5926:5926 \
              --restart unless-stopped \
              $APP_IMAGE

            echo "â³ Waiting for app to start..."
            sleep 10

            echo "ðŸ” Checking container status..."
            if docker ps --format '{{.Names}}' | grep -q "^${APP_CONTAINER}$"; then
              echo "âœ… Container is running!"
              echo "ðŸ“‹ Container logs (last 20 lines):"
              docker logs --tail 20 $APP_CONTAINER
            else
              echo "âŒ Container failed to start!"
              echo "ðŸ“‹ Container logs:"
              docker logs $APP_CONTAINER 2>&1 || true
              exit 1
            fi

            echo "âœ… Deployment successful!!"